<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Schedina ‚Äì Sblocco personalizzato & Verifica (Combo facile)</title>
<style>
  :root{
    --bg:#fffdf8; --ink:#1f2230; --muted:#60657a; --card:#ffffff; --line:#ece6ff;
    --accent:#6c7bff; --accent-2:#ff7db3; --accent-3:#7be3c5; --accent-4:#ffd56c;
    --ok:#1e9e69; --bad:#d9415f; --warn:#b98400;
    --shadow: 0 10px 30px rgba(28,25,68,.08), 0 3px 10px rgba(28,25,68,.06);
    --r:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1200px 600px at -10% -10%, #ffeef6 0%, transparent 65%),
      radial-gradient(1000px 600px at 110% -10%, #eef6ff 0%, transparent 60%),
      radial-gradient(800px 500px at 50% 120%, #eefff7 0%, transparent 55%),
      var(--bg);
    font:16px/1.45 ui-rounded, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial;
    padding:24px; display:flex; align-items:center; justify-content:center;
  }
  .wrap{width:100%; max-width:1120px; display:grid; gap:18px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px}
  h1{margin:0; font-size:26px; display:flex; align-items:center; gap:10px}
  h1 .logo{width:38px; height:38px; border-radius:12px; display:grid; place-items:center; font-size:20px;
    background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; box-shadow:var(--shadow)}
  .pill{background:#fff; border:2px dashed var(--accent); border-radius:999px; padding:8px 12px;
    font-weight:800; font-size:12px; color:var(--accent); display:flex; align-items:center; gap:8px}
  .grid{display:grid; gap:18px}
  @media(min-width:950px){ .grid{grid-template-columns:1.1fr .9fr} }
  .card{background:var(--card); border:2px solid var(--line); border-radius:var(--r); padding:18px; box-shadow:var(--shadow); position:relative}
  .card h2{margin:0 0 8px 0; font-size:19px; display:flex; align-items:center; gap:8px}
  .sticker{position:absolute; right:-8px; top:-10px; transform:rotate(6deg); background:#fff; border:2px dashed var(--accent); color:var(--accent);
    border-radius:12px; padding:6px 10px; font-size:12px; font-weight:900; box-shadow:var(--shadow)}
  .muted{color:var(--muted); font-size:13px}
  .tag{font-size:12px; font-weight:700; color:#fff; background:linear-gradient(135deg,var(--accent-3),var(--accent-2)); border-radius:999px; padding:4px 10px}

  label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
  input[type="text"],input[type="password"],input[type="date"],input[type="time"],textarea,select{
    width:100%; background:#fff; color:var(--ink); border:2px solid var(--line); border-radius:14px; padding:12px 14px;
    outline:none; transition:border-color .2s, box-shadow .2s; font-weight:600
  }
  input:focus,textarea:focus,select:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgba(108,123,255,.12)}
  textarea{min-height:150px; resize:vertical}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .btn{border:0; background:#1f2337; color:#fff; padding:12px 16px; border-radius:14px; cursor:pointer;
    font-weight:800; letter-spacing:.2px; box-shadow:var(--shadow); transform:translateY(0); transition:transform .06s ease,filter .2s ease,opacity .2s}
  .btn:hover{filter:brightness(1.04)} .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2))}
  .btn.good{background:linear-gradient(135deg,var(--accent-3),#3ac49b)}
  .btn.warn{background:linear-gradient(135deg,var(--accent-4),#ffae42); color:#3a2d00}
  .btn.ghost{background:#fff; color:var(--ink); border:2px dashed var(--line)}
  .btn:disabled{opacity:.6; cursor:not-allowed}

  .count{font-variant-numeric:tabular-nums; font-weight:900; font-size:28px; letter-spacing:.5px}
  .success{color:var(--ok); font-weight:800}
  .error{color:var(--bad); font-weight:800}
  .warnText{color:var(--warn); font-weight:800}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .sep{height:1px; background:var(--line); margin:12px 0}

  .pretty-list{list-style:none; padding:0; margin:0}
  .pretty-list li{padding:8px 10px; margin:6px 0; background:#fff; border:2px solid var(--line); border-radius:12px; font-weight:700;
    display:flex; align-items:center; gap:10px; justify-content:space-between}
  .left{display:flex; align-items:center; gap:10px}
  .pretty-dot{width:12px; height:12px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 0 0 3px rgba(108,123,255,.18)}
  .badge{padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; border:2px dashed var(--line)}
  .badge.win{background:#eaffe9; color:#0b6a3f; border-color:#bdf1c6}
  .badge.lose{background:#ffe9ef; color:#8a1031; border-color:#ffc0d0}
  .small{font-size:12px}
  .hl{background:#fff4b8; border-radius:6px; padding:1px 6px}
  .hl2{background:#ffd8ea; border-radius:6px; padding:1px 6px}

  .builder{border:2px dashed var(--line); border-radius:14px; padding:12px; background:#fff}
  .builder .row > div{min-width:150px}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:2px dashed var(--line); margin:6px 6px 0 0; font-size:12px; font-weight:800}
  .chip button{border:0; background:transparent; cursor:pointer; font-weight:900}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1><span class="logo">üé≤</span> Schedina ‚Äì <span style="font-weight:900; background:#fff; border-radius:10px; padding:2px 8px; border:2px dashed var(--line)">Sblocco personalizzato</span></h1>
    <div class="pill" id="statePill">‚ö™ Stato: <b>Inizializzazione‚Ä¶</b></div>
  </header>

  <div class="grid">
    <!-- EDITOR -->
    <section class="card" id="editorCard">
      <div class="sticker">‚úçÔ∏è Editor</div>
      <h2>‚úçÔ∏è Inserisci la schedina <span class="tag">si blocca alla tua data/ora</span></h2>
      <p class="muted">Puoi scrivere a mano oppure usare il <b>builder</b> con i men√π a tendina.</p>

      <!-- BUILDER -->
      <div class="builder">
        <div class="row">
          <div style="flex:1;min-width:170px">
            <label>Squadra Casa</label>
            <input id="bHome" type="text" placeholder="Frosinone">
          </div>
          <div style="flex:1;min-width:170px">
            <label>Squadra Ospite</label>
            <input id="bAway" type="text" placeholder="Cesena">
          </div>
          <div style="min-width:160px">
            <label>Tipo pronostico</label>
            <select id="bType">
              <option value="1X2">1X2</option>
              <option value="DC">Doppia Chance</option>
              <option value="OU">Over/Under</option>
              <option value="BTTS">GG/NG</option>
              <option value="COMBO">Combo</option>
            </select>
          </div>
        </div>

        <!-- Opzioni singolo -->
        <div class="row" id="bOptsSingle">
          <div data-for="1X2"><label>Scelta</label><select id="b1x2"><option>1</option><option>X</option><option>2</option></select></div>
          <div data-for="DC" style="display:none"><label>Scelta</label><select id="bDc"><option>1X</option><option>X2</option><option>12</option></select></div>
          <div data-for="OU" style="display:none">
            <label>Over/Under</label><select id="bOuPick"><option>Over</option><option>Under</option></select>
          </div>
          <div data-for="OU" style="display:none">
            <label>Soglia (opz., default 2.5)</label><input id="bOuThr" type="text" placeholder="2.5">
          </div>
          <div data-for="BTTS" style="display:none"><label>Scelta</label><select id="bBtts"><option value="GG">GG (Goal)</option><option value="NG">NG (NoGoal)</option></select></div>
        </div>

        <!-- Opzioni combo -->
        <div id="bOptsCombo" style="display:none">
          <label>Combo (aggiungi pezzi)</label>
          <div class="row">
            <select id="cType" style="min-width:150px">
              <option value="1X2">1X2</option>
              <option value="DC">Doppia Chance</option>
              <option value="OU">Over/Under</option>
              <option value="BTTS">GG/NG</option>
            </select>
            <select id="c1x2" style="min-width:100px">
              <option>1</option><option>X</option><option>2</option>
            </select>
            <select id="cDc" style="min-width:110px; display:none">
              <option>1X</option><option>X2</option><option>12</option>
            </select>
            <select id="cOuPick" style="min-width:120px; display:none">
              <option>Over</option><option>Under</option>
            </select>
            <input id="cOuThr" type="text" placeholder="(opz.) 2.5" style="display:none; width:120px">
            <select id="cBtts" style="min-width:120px; display:none">
              <option value="GG">GG</option><option value="NG">NG</option>
            </select>
            <button class="btn ghost" id="cAdd">+ Aggiungi pezzo</button>
          </div>
          <div id="cPreviewArea" class="small muted" style="margin-top:6px">Nessun pezzo aggiunto.</div>
        </div>

        <div class="row" style="margin-top:8px">
          <button class="btn good" id="bAddLine">‚ûï Aggiungi riga nel box</button>
          <span class="muted small">Formato auto: <span class="mono">Casa ‚Äì Ospite ‚Ä¶</span></span>
        </div>
      </div>

      <label for="title">Titolo/Etichetta</label>
      <input id="title" type="text" placeholder="Schedina Turno 34 ‚Äì Super combo">

      <label for="content">Contenuto (una riga per voce)</label>
      <textarea id="content" placeholder="Esempi:
Valencia ‚Äì Real Oviedo 1
Everton ‚Äì West Ham Over 2.5
Parma ‚Äì Torino X2
Dortmund ‚Äì A. Bilbao 1X + Over 2.5
Milan ‚Äì Lecce 1 + Under"></textarea>

      <div class="row">
        <div style="flex:1; min-width:240px">
          <label for="pass">Passphrase (per cifrare/decifrare)</label>
          <input id="pass" type="password" placeholder="La tua chiave segreta">
        </div>
        <div style="width:180px">
          <label for="tag">Tag</label>
          <input id="tag" type="text" placeholder="Settimana 38">
        </div>
      </div>

      <div class="row">
        <div style="width:180px"><label for="unlockDate">Data sblocco</label><input id="unlockDate" type="date"></div>
        <div style="width:140px"><label for="unlockTime">Ora sblocco</label><input id="unlockTime" type="time" step="60"></div>
        <div class="small muted">Zona oraria: <b>Europe/Rome</b> (DST safe)</div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="saveBtn">üíæ Salva & Blocca fino alla data scelta</button>
        <button class="btn ghost" id="clearBtn" title="Rimuove tutto e sblocca">üóëÔ∏è Pulisci</button>
        <span id="saveMsg" class="muted"></span>
      </div>

      <div id="editorLock" class="muted" style="margin-top:12px; display:none">
        <span class="warnText">Editor bloccato.</span> Torna modificabile <span class="mono" id="lockUntilText">‚Äî</span>.
      </div>
    </section>

    <!-- VIEWER / VERIFICA -->
    <section class="card" id="viewerCard">
      <div class="sticker" style="right:auto; left:-8px; transform:rotate(-6deg)">üîí Visualizza</div>
      <h2>üîí Visualizza & Verifica esito</h2>

      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <div class="muted">Stato sblocco</div>
          <div id="unlockState" style="font-weight:900">verifica‚Ä¶</div>
        </div>
        <div class="row" style="gap:10px">
          <div class="count" id="countdown">00:00:00:00</div>
          <div class="muted small">gg : hh : mm : ss</div>
        </div>
      </div>
      <div class="sep"></div>

      <label for="viewPass">Passphrase (necessaria dopo lo sblocco)</label>
      <input id="viewPass" type="password" placeholder="La stessa usata al salvataggio">

      <div class="row" style="margin-top:12px">
        <button class="btn good" id="viewBtn">üîì Mostra schedina</button>
        <button class="btn warn" id="resetWeekBtn" title="Dopo lo sblocco puoi ripartire pulito">üÜï Nuova settimana</button>
        <span id="viewMsg" class="muted"></span>
      </div>

      <div id="result" class="card" style="margin-top:14px; background:#fffdfc; border-style:solid">
        <div class="row" style="justify-content:space-between; gap:8px; flex-wrap:wrap">
          <div><span class="muted">Titolo:</span> <b id="resTitle">‚Äî</b></div>
          <div><span class="muted">Tag:</span> <b id="resTag">‚Äî</b></div>
        </div>
        <div class="sep"></div>

        <div id="resultsPanel" style="display:none">
          <p class="muted">Risultati preimpostati a <b>0 ‚Äì 0</b>. Modificali e premi <b>Valuta esito</b>. Puoi anche incollare un elenco ‚Äú2-1, 1-1‚Ä¶‚Äù</p>
          <div class="row" style="align-items:flex-start">
            <button class="btn good" id="evaluateBtn">‚úÖ Valuta esito</button>
            <div>
              <label for="bulkScores" class="small">Incolla risultati in blocco</label>
              <textarea id="bulkScores" placeholder="2-1
1-1
0-0" style="min-height:80px; width:260px"></textarea>
            </div>
            <button class="btn ghost" id="applyBulkBtn" title="Applica ai campi sotto nell'ordine">üì• Applica in ordine</button>
          </div>

          <ul class="pretty-list" id="linesList">
            <li class="muted" style="font-weight:600">Nessun dato da mostrare.</li>
          </ul>

          <div class="sep"></div>
          <div id="summary" class="muted">‚Äî</div>
        </div>
      </div>

      <p class="muted" style="margin-top:10px">
        Dati salvati localmente (<span class="mono">localStorage</span>) e cifrati (AES-GCM + PBKDF2). Zona oraria: Europe/Rome (con ora legale).
      </p>
    </section>
  </div>
</div>

<script>
/* ===== Time utils con offset reale Europe/Rome (DST safe) ===== */
function getTZOffsetMinutes(timeZone, y,m,d,hh,mm){
  const dtf = new Intl.DateTimeFormat('en-GB',{timeZone, timeZoneName:'shortOffset', year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false});
  const parts = dtf.formatToParts(new Date(Date.UTC(y,m-1,d,hh,mm,0)));
  const tzn = parts.find(p=>p.type==='timeZoneName')?.value || 'GMT+0';
  const m2 = tzn.match(/GMT([+-]\d{1,2})(?::(\d{2}))?/i);
  if(!m2) return 0;
  const sign = m2[1].startsWith('-')?-1:1;
  const h = Math.abs(parseInt(m2[1],10));
  const mi = m2[2]? parseInt(m2[2],10) : 0;
  return sign*(h*60+mi);
}
function makeISOInTZ(dateStr,timeStr,tz='Europe/Rome'){
  const [y,m,d] = dateStr.split('-').map(n=>+n); 
  let [hh,mm] = (timeStr||'21:00').split(':').map(n=>+n);
  const off = getTZOffsetMinutes(tz,y,m,d,hh,mm);
  const utcMs = Date.UTC(y,m-1,d,hh,mm,0) - off*60*1000; // local - offset = UTC
  return new Date(utcMs).toISOString();
}
function msUntilISO(iso){ return new Date(iso).getTime() - Date.now(); }
function fmtCountdown(ms){ if(ms<0) ms=0; const s=Math.floor(ms/1000), d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), sec=s%60; const pad=n=>String(n).padStart(2,'0'); return `${pad(d)}:${pad(h)}:${pad(m)}:${pad(sec)}`; }

/* ===== Storage & Crypto ===== */
const KEY_DATA='schedina.pkg', KEY_META='schedina.meta'; 
function saveMeta(meta){ localStorage.setItem(KEY_META, JSON.stringify(meta)); }
function loadMeta(){ try{return JSON.parse(localStorage.getItem(KEY_META)||'null')}catch{return null} }
function clearAll(){ localStorage.removeItem(KEY_DATA); localStorage.removeItem(KEY_META); }
function hasSaved(){ return !!localStorage.getItem(KEY_DATA); }

function b64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function fromB64(b){ return Uint8Array.from(atob(b), c=>c.charCodeAt(0)); }
async function deriveKey(pass,salt){
  const enc=new TextEncoder();
  const mat=await crypto.subtle.importKey('raw',enc.encode(pass),{name:'PBKDF2'},false,['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:120000,hash:'SHA-256'}, mat,{name:'AES-GCM',length:256}, false, ['encrypt','decrypt']);
}
async function encryptJSON(obj,pass){
  const enc=new TextEncoder(); const iv=crypto.getRandomValues(new Uint8Array(12)); const salt=crypto.getRandomValues(new Uint8Array(16));
  const key=await deriveKey(pass,salt); const data=enc.encode(JSON.stringify(obj));
  const ct=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,data);
  return {v:1,iv:b64(iv),salt:b64(salt),ct:b64(ct)};
}
async function decryptJSON(pkg,pass){
  const iv=fromB64(pkg.iv), salt=fromB64(pkg.salt), ct=fromB64(pkg.ct);
  const key=await deriveKey(pass,salt);
  const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,ct);
  return JSON.parse(new TextDecoder().decode(pt));
}

/* ===== UI refs ===== */
const statePill=document.getElementById('statePill');
const saveBtn=document.getElementById('saveBtn'), clearBtn=document.getElementById('clearBtn');
const saveMsg=document.getElementById('saveMsg'), editorLock=document.getElementById('editorLock'), lockUntilText=document.getElementById('lockUntilText');
const titleEl=document.getElementById('title'), contentEl=document.getElementById('content'), passEl=document.getElementById('pass'), tagEl=document.getElementById('tag');
const unlockDateEl=document.getElementById('unlockDate'), unlockTimeEl=document.getElementById('unlockTime');

const unlockState=document.getElementById('unlockState'), countdownEl=document.getElementById('countdown');
const viewPassEl=document.getElementById('viewPass'), viewBtn=document.getElementById('viewBtn'), resetWeekBtn=document.getElementById('resetWeekBtn'), viewMsg=document.getElementById('viewMsg');
const resTitle=document.getElementById('resTitle'), resTag=document.getElementById('resTag'), resultsPanel=document.getElementById('resultsPanel'), linesList=document.getElementById('linesList'), summary=document.getElementById('summary');
const evaluateBtn=document.getElementById('evaluateBtn'), bulkScores=document.getElementById('bulkScores'), applyBulkBtn=document.getElementById('applyBulkBtn');

/* ===== Builder refs ===== */
const bHome=document.getElementById('bHome'), bAway=document.getElementById('bAway'), bType=document.getElementById('bType');
const b1x2=document.getElementById('b1x2'), bDc=document.getElementById('bDc'), bOuPick=document.getElementById('bOuPick'), bOuThr=document.getElementById('bOuThr'), bBtts=document.getElementById('bBtts');

const bOptsSingle=document.getElementById('bOptsSingle'), bOptsCombo=document.getElementById('bOptsCombo');
const cType=document.getElementById('cType'), c1x2=document.getElementById('c1x2'), cDc=document.getElementById('cDc'), cOuPick=document.getElementById('cOuPick'), cOuThr=document.getElementById('cOuThr'), cBtts=document.getElementById('cBtts'), cAdd=document.getElementById('cAdd'), cPreviewArea=document.getElementById('cPreviewArea');
const bAddLine=document.getElementById('bAddLine');
let comboParts=[];

bType.addEventListener('change', ()=>{
  // mostra blocchi corretti
  if(bType.value==='COMBO'){ bOptsSingle.style.display='none'; bOptsCombo.style.display='block'; }
  else { bOptsSingle.style.display='flex'; bOptsCombo.style.display='none'; }
  // mostra opzioni corrette per i singoli
  document.querySelectorAll('#bOptsSingle [data-for]').forEach(el=> el.style.display='none');
  document.querySelectorAll(`#bOptsSingle [data-for="${bType.value}"]`).forEach(el=> el.style.display='block');
});
cType.addEventListener('change', ()=>{
  c1x2.style.display = cType.value==='1X2' ? 'inline-block' : 'none';
  cDc.style.display  = cType.value==='DC'  ? 'inline-block' : 'none';
  cOuPick.style.display = cOuThr.style.display = (cType.value==='OU') ? 'inline-block' : 'none';
  cBtts.style.display = cType.value==='BTTS' ? 'inline-block' : 'none';
});
cAdd.addEventListener('click',(e)=>{
  e.preventDefault();
  let piece='';
  if(cType.value==='1X2'){ piece = c1x2.value; }
  if(cType.value==='DC'){ piece = cDc.value; }
  if(cType.value==='OU'){ piece = `${cOuPick.value} ${cOuThr.value.trim()||'2.5'}`; }
  if(cType.value==='BTTS'){ piece = cBtts.value; }
  if(!piece) return;
  comboParts.push(piece);
  refreshComboPreview();
});
function refreshComboPreview(){
  if(comboParts.length===0){ cPreviewArea.textContent='Nessun pezzo aggiunto.'; return; }
  cPreviewArea.innerHTML = comboParts.map((p,i)=>`<span class="chip">${p} <button data-i="${i}" title="Rimuovi">√ó</button></span>`).join('');
  // delete handlers
  cPreviewArea.querySelectorAll('button[data-i]').forEach(btn=>{
    btn.onclick = ()=>{ const i=+btn.getAttribute('data-i'); comboParts.splice(i,1); refreshComboPreview(); };
  });
}
bAddLine.addEventListener('click',(e)=>{
  e.preventDefault();
  const home=bHome.value.trim(), away=bAway.value.trim();
  if(!home || !away) return;
  let market='';
  if(bType.value==='1X2') market = b1x2.value;
  if(bType.value==='DC')  market = bDc.value;
  if(bType.value==='OU')  market = `${bOuPick.value} ${bOuThr.value.trim()||'2.5'}`;
  if(bType.value==='BTTS')market = bBtts.value;
  if(bType.value==='COMBO') market = comboParts.join(' + ');
  if(!market) return;
  contentEl.value = (contentEl.value? contentEl.value+'\n':'') + `${home} ‚Äì ${away} ${market}`;
  if(bType.value==='COMBO'){ comboParts=[]; refreshComboPreview(); }
});

/* ===== Stato editor ===== */
function setLockedUI(iso){
  [titleEl,contentEl,passEl,tagEl,unlockDateEl,unlockTimeEl,saveBtn].forEach(el=>el.disabled=true);
  editorLock.style.display='block';
  lockUntilText.textContent=new Intl.DateTimeFormat('it-IT',{timeZone:'Europe/Rome',weekday:'long',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(new Date(iso));
  statePill.innerHTML='üü£ Stato: <b>Bloccato</b>';
}
function setUnlockedUI(){
  [titleEl,contentEl,passEl,tagEl,unlockDateEl,unlockTimeEl,saveBtn].forEach(el=>el.disabled=false);
  editorLock.style.display='none';
  statePill.innerHTML='üü¢ Stato: <b>Sbloccato</b>';
}
function refreshState(){
  const meta=loadMeta();
  if(!meta){ setUnlockedUI(); unlockState.innerHTML='üü° In attesa di salvataggio'; countdownEl.textContent='00:00:00:00'; return; }
  setLockedUI(meta.lockedUntilISO);
}
function tick(){
  const meta=loadMeta();
  if(!meta){ requestAnimationFrame(()=>setTimeout(tick,600)); return; }
  const remain=msUntilISO(meta.lockedUntilISO);
  countdownEl.textContent=fmtCountdown(remain);
  unlockState.innerHTML = (remain<=0) ? '<span class="success">‚úÖ Sbloccato: puoi visualizzare</span>' : 'üîí Ancora bloccato fino alla data impostata';
  requestAnimationFrame(()=>setTimeout(tick,500));
}

/* ===== Save / Clear ===== */
async function handleSave(){
  saveMsg.textContent='';
  const title=(titleEl.value||'').trim();
  const content=(contentEl.value||'').trim();
  const pass=(passEl.value||'').trim();
  const tag=(tagEl.value||'').trim();
  const dateStr=unlockDateEl.value, timeStr=unlockTimeEl.value||'21:00';
  if(!title || !content || !pass || !dateStr){ saveMsg.innerHTML='<span class="error">Compila titolo, contenuto, passphrase e data di sblocco.</span>'; return; }
  const lockedUntilISO=makeISOInTZ(dateStr,timeStr,'Europe/Rome');
  if(msUntilISO(lockedUntilISO)<=0){ saveMsg.innerHTML='<span class="error">La data/ora di sblocco deve essere nel futuro.</span>'; return; }
  try{
    const pkg=await encryptJSON({title,content,tag,savedAt:new Date().toISOString()},pass);
    localStorage.setItem(KEY_DATA, JSON.stringify(pkg));
    saveMeta({lockedUntilISO});
    setLockedUI(lockedUntilISO);
    saveMsg.innerHTML='<span class="success">üéâ Salvato! Ora √® bloccato fino alla tua data/ora.</span>';
    burst();
  }catch{ saveMsg.innerHTML='<span class="error">Errore nel salvataggio.</span>'; }
}
function handleClear(){
  clearAll(); setUnlockedUI();
  saveMsg.innerHTML='<span class="success">Pulito tutto. Editor sbloccato.</span>';
  resTitle.textContent='‚Äî'; resTag.textContent='‚Äî'; resultsPanel.style.display='none'; linesList.innerHTML='<li class="muted" style="font-weight:600">Nessun dato da mostrare.</li>'; summary.textContent='‚Äî';
  unlockState.innerHTML='üü° In attesa di salvataggio'; countdownEl.textContent='00:00:00:00';
}
function handleResetWeek(){
  const meta=loadMeta(); if(!meta){ viewMsg.innerHTML='<span class="error">Non c‚Äô√® nulla da resettare.</span>'; return; }
  if(msUntilISO(meta.lockedUntilISO)>0){ viewMsg.innerHTML='<span class="error">Puoi azzerare solo dopo lo sblocco.</span>'; return; }
  handleClear(); viewMsg.innerHTML='<span class="success">Settimana azzerata. Puoi inserire una nuova schedina!</span>';
}

/* ===== Parser con COMBO e OU ‚Äúsenza soglia‚Äù (default 2.5) ===== */
const sepRegex = /\s*[-‚Äì‚Äî]\s*/;
const comboSep = /\s*(?:\+|&|,|\be\b)\s*/i;
function parseLine(raw){
  if(!raw) return null;
  const line = raw.trim().replace(/\s+/g,' ');
  let home='', away='';
  if(sepRegex.test(line)){
    const [lhs, rhs] = line.split(sepRegex);
    home = removeMarkets(lhs).trim(); away = removeMarkets(rhs).trim();
  }
  const mkts = extractMarkets(line);
  if(mkts.length===0) return {home,away,market:{type:'UNKNOWN',raw:line},rawLine:raw};
  return (mkts.length===1) ? {home,away,market:mkts[0],rawLine:raw} : {home,away,market:{type:'COMBO',picks:mkts},rawLine:raw};
}
function removeMarkets(t){
  let s=t;
  s=s.replace(/\b1X2\s*:\s*([12X])\b/gi,' ');
  s=s.replace(/\b(1X|X2|12)\b/gi,' ');
  s=s.replace(/\b([12X])\b/g,' ');
  s=s.replace(/\bU\/O\s*([0-9]*\.?[0-9]+)\s*:\s*(O|U)\b/gi,' ');
  s=s.replace(/\b([OU])\s*([0-9]*\.?[0-9]+)\b/gi,' ');
  s=s.replace(/\b(OVER|UNDER)(?:\s*([0-9]*\.?[0-9]+))?\b/gi,' '); // accetta anche senza numero
  s=s.replace(/\b(GG|BTTS|GOAL|NG|NO\s*GOAL)\b/gi,' ');
  s=s.replace(comboSep,' ');
  return s;
}
function extractMarkets(text){
  const parts = text.split(comboSep).map(s=>s.trim()).filter(Boolean);
  const found=[];
  const push=m=>{ if(m) found.push(m); };
  for(const p of parts){ const m=extractSingleMarket(p); if(m) push(m); }
  if(found.length===0){ scanAllMarkets(text).forEach(push); }
  const key=m=>{
    if(m.type==='OU') return `OU-${m.pick}-${m.threshold??'def'}`;
    if(m.type==='1X2')return `1X2-${m.pick}`;
    if(m.type==='DC') return `DC-${m.pick}`;
    if(m.type==='BTTS')return `BTTS-${m.pick}`;
    return 'UNK';
  };
  const seen=new Set(); return found.filter(m=>{const k=key(m); if(seen.has(k))return false; seen.add(k); return true;});
}
function readThr(str){ if(str==null||str==='') return NaN; const m=String(str).match(/^([0-9]*\.?[0-9]+)$/); return m? parseFloat(m[1]) : NaN; }
function extractSingleMarket(t){
  const T=t.toUpperCase();

  // 1X2 esplicito
  let m=T.match(/\b1X2\s*:\s*([12X])\b/); if(m) return {type:'1X2',pick:m[1]};
  // DC
  m=T.match(/\b(1X|X2|12)\b/); if(m) return {type:'DC',pick:m[1]};
  // 1/X/2 singolo se non c'√® DC
  if(!/\b(1X|X2|12)\b/.test(T)){ m=T.match(/\b([12X])\b/); if(m) return {type:'1X2',pick:m[1]}; }

  // U/O thr:O|U
  m=T.match(/\bU\/O\s*([0-9]*\.?[0-9]+)\s*:\s*(O|U)\b/);
  if(m){ const thr=readThr(m[1]); const pick=m[2]==='O'?'OVER':'UNDER'; if(!isNaN(thr)) return {type:'OU',pick,threshold:thr}; }

  // O thr / U thr
  m=T.match(/\b([OU])\s*([0-9]*\.?[0-9]+)\b/);
  if(m){ const thr=readThr(m[2]); const pick=m[1]==='O'?'OVER':'UNDER'; if(!isNaN(thr)) return {type:'OU',pick,threshold:thr}; }

  // Over/Under con o senza numero (default 2.5)
  m=T.match(/\b(OVER|UNDER)(?:\s*([0-9]*\.?[0-9]+))?\b/);
  if(m){ const thr=readThr(m[2]); return {type:'OU',pick:m[1],threshold:isNaN(thr)?2.5:thr}; }

  // BTTS
  m=T.match(/\b(GG|BTTS|GOAL)\b/); if(m) return {type:'BTTS',pick:'GG'};
  m=T.match(/\b(NG|NO\s*GOAL)\b/); if(m) return {type:'BTTS',pick:'NG'};

  return null;
}
function scanAllMarkets(text){
  const T=text.toUpperCase(); const arr=[]; let m;
  const dcRe=/\b(1X|X2|12)\b/g; while((m=dcRe.exec(T))!==null){ arr.push({type:'DC',pick:m[1]}); }
  const x2v=/\b1X2\s*:\s*([12X])\b/g; while((m=x2v.exec(T))!==null){ arr.push({type:'1X2',pick:m[1]}); }
  const uoC=/\bU\/O\s*([0-9]*\.?[0-9]+)\s*:\s*(O|U)\b/g; while((m=uoC.exec(T))!==null){ arr.push({type:'OU',pick:(m[2]==='O'?'OVER':'UNDER'),threshold:parseFloat(m[1])}); }
  const shortOU=/\b([OU])\s*([0-9]*\.?[0-9]+)\b/g; while((m=shortOU.exec(T))!==null){ arr.push({type:'OU',pick:(m[1]==='O'?'OVER':'UNDER'),threshold:parseFloat(m[2])}); }
  const longOU=/\b(OVER|UNDER)(?:\s*([0-9]*\.?[0-9]+))?\b/g; while((m=longOU.exec(T))!==null){ const thr = m[2]?parseFloat(m[2]):2.5; arr.push({type:'OU',pick:m[1],threshold:thr}); }
  const gg=/\b(GG|BTTS|GOAL)\b/g; while((m=gg.exec(T))!==null){ arr.push({type:'BTTS',pick:'GG'}); }
  const ng=/\b(NG|NO\s*GOAL)\b/g; while((m=ng.exec(T))!==null){ arr.push({type:'BTTS',pick:'NG'}); }
  if(!/\b(1X|X2|12)\b/.test(T)){ const single=/\b([12X])\b/g; while((m=single.exec(T))!==null){ arr.push({type:'1X2',pick:m[1]}); } }
  return arr;
}

/* ===== Valutazione ===== */
function evaluateSingle(m,hg,ag){
  const h=Number(hg), a=Number(ag); if(!Number.isFinite(h)||!Number.isFinite(a)||h<0||a<0) return {ok:false};
  const tot=h+a;
  switch(m.type){
    case '1X2':{ const r=h>a?'1':(h<a?'2':'X'); return {ok:r===m.pick}; }
    case 'DC': { const r=h>a?'1':(h<a?'2':'X'); return {ok:m.pick.includes(r)}; }
    case 'OU': { const thr = (typeof m.threshold==='number' && !isNaN(m.threshold)) ? m.threshold : 2.5; return {ok: m.pick==='OVER' ? (tot>thr) : (tot<thr)}; }
    case 'BTTS':{ const both=(h>0 && a>0); return {ok:m.pick==='GG'? both : !both}; }
    default: return {ok:false};
  }
}
function evaluateMarket(m,h,a){
  if(m.type==='COMBO'){ const rs=m.picks.map(p=>evaluateSingle(p,h,a)); return {ok:rs.every(x=>x.ok)}; }
  return evaluateSingle(m,h,a);
}
function renderMarket(m){
  if(m.type==='1X2') return `1X2: <span class="hl">${m.pick}</span>`;
  if(m.type==='DC')  return `Doppia Chance: <span class="hl">${m.pick}</span>`;
  if(m.type==='OU')  return `<span class="hl2">${m.pick}</span> ${m.threshold ?? '2.5'}`;
  if(m.type==='BTTS')return (m.pick==='GG'?'Goal (entrambi segnano)':'NoGoal');
  if(m.type==='COMBO')return m.picks.map(renderMarket).join(' <span class="small muted">+</span> ');
  return `<span class="warnText">Pronostico non riconosciuto</span>`;
}

/* ===== View flow ===== */
let resultRows=[];
async function handleView(){
  viewMsg.textContent='';
  const meta=loadMeta(); if(!meta){ viewMsg.innerHTML='<span class="error">Nessuna schedina salvata.</span>'; return; }
  if(msUntilISO(meta.lockedUntilISO)>0){ viewMsg.innerHTML='<span class="error">Disponibile solo dopo lo sblocco.</span>'; return; }
  const pkgStr=localStorage.getItem(KEY_DATA); if(!pkgStr){ viewMsg.innerHTML='<span class="error">Dati mancanti.</span>'; return; }
  const pass=(viewPassEl.value||'').trim(); if(!pass){ viewMsg.innerHTML='<span class="error">Inserisci la passphrase.</span>'; return; }
  try{
    const data=await decryptJSON(JSON.parse(pkgStr),pass);
    resTitle.textContent=data.title||'‚Äî'; resTag.textContent=data.tag||'‚Äî';
    const lines=(data.content||'').split('\n').map(s=>s.trim()).filter(Boolean);
    const parsed=lines.map(parseLine);
    linesList.innerHTML=''; resultRows=[];
    parsed.forEach((item)=>{
      const li=document.createElement('li');
      const left=document.createElement('div'); left.className='left';
      const dot=document.createElement('span'); dot.className='pretty-dot';
      const label=document.createElement('div');
      const teams = (item.home||item.away) ? `${item.home||'‚Äî'} vs ${item.away||'‚Äî'}` : 'Partita';
      label.innerHTML = `<div><b>${teams}</b></div><div class="small muted">${renderMarket(item.market)}</div>`;
      left.appendChild(dot); left.appendChild(label);
      const right=document.createElement('div');
      const hIn=document.createElement('input'); hIn.type='number'; hIn.min='0'; hIn.step='1'; hIn.value='0'; hIn.style.width='64px';
      const sep=document.createElement('span'); sep.className='mono muted'; sep.textContent=' - ';
      const aIn=document.createElement('input'); aIn.type='number'; aIn.min='0'; aIn.step='1'; aIn.value='0'; aIn.style.width='64px';
      const badge=document.createElement('span'); badge.className='badge'; badge.textContent='?'; badge.style.marginLeft='8px';
      right.appendChild(hIn); right.appendChild(sep); right.appendChild(aIn); right.appendChild(badge);
      li.appendChild(left); li.appendChild(right);
      linesList.appendChild(li);
      resultRows.push({parsed:item,hIn,aIn,badge});
    });
    resultsPanel.style.display='block';
    viewMsg.innerHTML='<span class="success">Schedina caricata ‚úî</span>';
  }catch{ viewMsg.innerHTML='<span class="error">Passphrase errata o dati corrotti.</span>'; }
}
function applyBulk(){
  const rows=(bulkScores.value||'').split('\n').map(s=>s.trim()).filter(Boolean);
  for(let i=0;i<rows.length && i<resultRows.length;i++){
    const m=rows[i].match(/^(\d+)\s*[-:]\s*(\d+)$/);
    if(m){ resultRows[i].hIn.value=m[1]; resultRows[i].aIn.value=m[2]; }
  }
}
function doEvaluate(){
  if(resultRows.length===0){ summary.textContent='Nessuna riga da valutare.'; return; }
  let wins=0, total=0, unknown=0;
  resultRows.forEach(row=>{
    total++;
    const item=row.parsed, h=row.hIn.value, a=row.aIn.value;
    if(!item || !item.market || item.market.type==='UNKNOWN'){ row.badge.className='badge lose'; row.badge.textContent='?'; unknown++; return; }
    const ex=evaluateMarket(item.market,h,a);
    if(ex.ok){ row.badge.className='badge win'; row.badge.textContent='OK'; wins++; }
    else { row.badge.className='badge lose'; row.badge.textContent='KO'; }
  });
  const allOk=(wins===total-unknown)&&unknown===0&&total>0;
  summary.innerHTML = allOk ? `üèÜ <b>Schedina VINCENTE</b> ‚Äì ${wins}/${total} corretti`
                            : `‚ÑπÔ∏è Esito: ${wins}/${total} corretti` + (unknown? ` (‚ö†Ô∏è ${unknown} non riconosciuti)`:'');
}

/* ===== Confetti & Init ===== */
function burst(){
  const emojis=['‚ú®','üéâ','üí•','üéä','üåü']; for(let i=0;i<14;i++){ const s=document.createElement('div');
    s.textContent=emojis[Math.floor(Math.random()*emojis.length)]; s.style.position='fixed';
    s.style.left=(window.innerWidth/2+(Math.random()-0.5)*240)+'px'; s.style.top=(window.innerHeight/2+(Math.random()-0.5)*80)+'px';
    s.style.fontSize=(18+Math.random()*10)+'px'; s.style.transform=`rotate(${(Math.random()*40-20)}deg)`; s.style.opacity='1';
    s.style.transition='transform 700ms ease-out, opacity 700ms ease-out'; document.body.appendChild(s);
    requestAnimationFrame(()=>{ s.style.transform += ` translate(${(Math.random()-0.5)*160}px, ${60+Math.random()*120}px)`; s.style.opacity='0'; });
    setTimeout(()=>s.remove(),800);
  }
}
function initDefaultsForUnlock(){
  // Default: prossima domenica ore 21:00 (Rome)
  const now=new Date(); const wd=now.getDay(); const add=(7 - wd) % 7 || 7;
  const next=new Date(now.getFullYear(), now.getMonth(), now.getDate()+add);
  const y=next.getFullYear(), m=String(next.getMonth()+1).padStart(2,'0'), d=String(next.getDate()).padStart(2,'0');
  document.getElementById('unlockDate').value=`${y}-${m}-${d}`;
  document.getElementById('unlockTime').value='21:00';
}
function init(){
  refreshState(); tick();
  saveBtn.addEventListener('click', handleSave);
  clearBtn.addEventListener('click', handleClear);
  viewBtn.addEventListener('click', handleView);
  resetWeekBtn.addEventListener('click', handleResetWeek);
  evaluateBtn.addEventListener('click', doEvaluate);
  applyBulkBtn.addEventListener('click', applyBulk);
  initDefaultsForUnlock();
  // builder defaults
  bType.dispatchEvent(new Event('change'));
  cType.dispatchEvent(new Event('change'));
  if(hasSaved()){ document.title='Schedina ‚Äì bloccata fino allo sblocco'; }
}
init();
</script>
</body>
</html>
