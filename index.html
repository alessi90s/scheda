<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Schedina ‚Äì Settimana in gioco</title>
<style>
  :root{
    /* Pastelli giocosi */
    --bg:#fffdf8;
    --ink:#1f2230;
    --muted:#60657a;
    --card:#ffffff;
    --line:#ece6ff;
    --accent:#6c7bff;     /* lilla/indaco dolce */
    --accent-2:#ff7db3;   /* rosa */
    --accent-3:#7be3c5;   /* menta */
    --accent-4:#ffd56c;   /* giallo crema */
    --ok:#1e9e69;
    --bad:#d9415f;
    --warn:#b98400;

    --shadow: 0 10px 30px rgba(28,25,68,.08), 0 3px 10px rgba(28,25,68,.06);
    --r:22px; /* rounded xl */
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); background:
      radial-gradient(1200px 600px at -10% -10%, #ffeef6 0%, transparent 65%),
      radial-gradient(1000px 600px at 110% -10%, #eef6ff 0%, transparent 60%),
      radial-gradient(800px 500px at 50% 120%, #eefff7 0%, transparent 55%),
      var(--bg);
    font:16px/1.45 ui-rounded, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Inter, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    padding:24px;
    display:flex; align-items:center; justify-content:center;
  }

  .wrap{width:100%; max-width:1020px; display:grid; gap:18px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px}
  h1{margin:0; font-size:26px; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
  h1 .logo{
    width:38px; height:38px; border-radius:12px;
    display:grid; place-items:center; font-size:20px;
    background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
    color:#fff; box-shadow: var(--shadow);
  }
  .pill{
    background: #fff;
    border:2px dashed var(--accent);
    border-radius:999px; padding:8px 12px; font-weight:800; font-size:12px; color:var(--accent);
    display:flex; align-items:center; gap:8px;
  }

  .grid{display:grid; gap:18px}
  @media(min-width:900px){ .grid{grid-template-columns:1.05fr .95fr} }

  .card{
    background: var(--card);
    border: 2px solid var(--line);
    border-radius: var(--r);
    padding: 18px;
    box-shadow: var(--shadow);
    position:relative;
  }
  .card h2{margin:0 0 8px 0; font-size:19px; display:flex; align-items:center; gap:8px}
  .tag{
    font-size:12px; font-weight:700; color:#fff;
    background: linear-gradient(135deg, var(--accent-3), var(--accent-2));
    border-radius:999px; padding:4px 10px;
  }
  .muted{color:var(--muted); font-size:13px}

  label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
  input[type="text"], input[type="password"], textarea{
    width:100%; background:#fff; color:var(--ink);
    border:2px solid var(--line); border-radius:14px; padding:12px 14px;
    outline:none; transition:border-color .2s, box-shadow .2s; font-weight:600;
  }
  input:focus, textarea:focus{ border-color: var(--accent); box-shadow: 0 0 0 4px rgba(108,123,255,.12) }
  textarea{min-height:150px; resize:vertical}

  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
  .btn{
    border:0; background:#1f2337; color:#fff; padding:12px 16px; border-radius:14px; cursor:pointer;
    font-weight:800; letter-spacing:.2px; box-shadow: var(--shadow); transform: translateY(0);
    transition: transform .06s ease, filter .2s ease, opacity .2s;
  }
  .btn:hover{filter:brightness(1.04)}
  .btn:active{transform: translateY(1px)}
  .btn.primary{background: linear-gradient(135deg, var(--accent), var(--accent-2))}
  .btn.good{background: linear-gradient(135deg, var(--accent-3), #3ac49b)}
  .btn.warn{background: linear-gradient(135deg, var(--accent-4), #ffae42); color:#3a2d00}
  .btn.ghost{background:#fff; color:var(--ink); border:2px dashed var(--line)}
  .btn:disabled{opacity:.6; cursor:not-allowed}

  .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:6px}
  .chip{
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800; color:#2b2e3d; border:2px dashed var(--line);
    background: #fff;
  }
  .chip.fixed{background: #fff8c8}
  .chip.over{background: #ffe1f0}
  .chip.alt{background: #dffcf3}

  .callout{
    border-radius:14px; background: #fff; border:2px dashed var(--line); padding:10px 12px;
  }
  .count{
    font-variant-numeric: tabular-nums; font-weight:900; font-size:28px; letter-spacing:.5px;
  }
  .center{display:flex; align-items:center; justify-content:center}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .success{color:var(--ok); font-weight:800}
  .error{color:var(--bad); font-weight:800}

  /* ‚ÄúAdesivi‚Äù giocosi */
  .sticker{
    position:absolute; right:-8px; top:-10px; transform:rotate(6deg);
    background:#fff; border:2px dashed var(--accent); color:var(--accent);
    border-radius:12px; padding:6px 10px; font-size:12px; font-weight:900;
    box-shadow: var(--shadow);
  }

  /* Lista risultato con pallini ciccioni */
  .pretty-list{list-style:none; padding:0; margin:0}
  .pretty-list li{
    padding:8px 10px; margin:6px 0; background:#fff; border:2px solid var(--line); border-radius:12px; font-weight:700;
    display:flex; align-items:center; gap:10px;
  }
  .pretty-dot{
    width:12px; height:12px; border-radius:50%;
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    box-shadow: 0 0 0 3px rgba(108,123,255,.18);
  }
  .hl{background:#fff4b8; border-radius:6px; padding:1px 6px}
  .hl2{background:#ffd8ea; border-radius:6px; padding:1px 6px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1><span class="logo">üé≤</span> Schedina ‚Äì <span style="font-weight:900; background:#fff; border-radius:10px; padding:2px 8px; border:2px dashed var(--line)">Settimana in gioco</span></h1>
      <div class="pill" id="statePill">‚ö™ Stato: <b>Inizializzazione‚Ä¶</b></div>
    </header>

    <div class="grid">
      <!-- EDITOR -->
      <section class="card" id="editorCard">
        <div class="sticker">‚úçÔ∏è Editor</div>
        <h2>‚úçÔ∏è Inserisci la schedina</h2>
        <p class="muted">
          All‚Äôinizio √® <b>sbloccato</b>. Quando salvi <span class="hl">si blocca fino a Domenica 21:00</span>.
          I dati restano solo sul tuo browser, cifrati con la tua passphrase.
        </p>
        <div class="chips">
          <span class="chip fixed">1X2</span>
          <span class="chip over">Over/Under</span>
          <span class="chip alt">Altro</span>
        </div>

        <label for="title">Titolo/Etichetta</label>
        <input id="title" type="text" placeholder="Schedina super color ‚Äì Turno 34">

        <label for="content">Contenuto (una riga per voce)</label>
        <textarea id="content" placeholder="Napoli ‚Äì Pisa 1
Frosinone ‚Äì Cagliari X
Udinese ‚Äì Palermo 1
Milan ‚Äì Lecce 1
Ath. Bilbao ‚Äì Girona Over 2.5"></textarea>

        <div class="row">
          <div style="flex:1; min-width:240px">
            <label for="pass">Passphrase (per cifrare/decifrare)</label>
            <input id="pass" type="password" placeholder="La tua chiave segreta">
          </div>
          <div style="width:180px">
            <label for="tag">Tag</label>
            <input id="tag" type="text" placeholder="Settimana 38">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="saveBtn">üíæ Salva & Blocca fino a Domenica</button>
          <button class="btn ghost" id="clearBtn" title="Rimuove tutto e sblocca se era bloccato">üóëÔ∏è Pulisci</button>
          <span id="saveMsg" class="muted"></span>
        </div>

        <div id="editorLock" class="callout" style="margin-top:12px; display:none">
          <b>Editor bloccato.</b> Hai gi√† salvato una schedina. Torner√† modificabile <span class="mono" id="lockUntilText">Domenica 21:00</span>.
        </div>
      </section>

      <!-- VIEWER -->
      <section class="card" id="viewerCard">
        <div class="sticker" style="right:auto; left:-8px; transform:rotate(-6deg)">üîí Visualizza</div>
        <h2>üîí Visualizza schedina</h2>

        <div class="callout">
          <div class="row" style="justify-content:space-between; align-items:flex-end">
            <div>
              <div class="muted">Stato sblocco</div>
              <div id="unlockState" style="font-weight:900">verifica‚Ä¶</div>
            </div>
            <div class="center" style="gap:10px">
              <div class="count" id="countdown">00:00:00:00</div>
              <div class="muted" style="font-size:12px">gg : hh : mm : ss</div>
            </div>
          </div>
        </div>

        <label for="viewPass">Passphrase (necessaria quando sbloccato)</label>
        <input id="viewPass" type="password" placeholder="La stessa usata al salvataggio">

        <div class="row" style="margin-top:12px">
          <button class="btn good" id="viewBtn">üîì Mostra</button>
          <button class="btn warn" id="resetWeekBtn" title="Dopo lo sblocco puoi ripartire pulito">üÜï Nuova settimana</button>
          <span id="viewMsg" class="muted"></span>
        </div>

        <div id="result" class="card" style="margin-top:14px; background:#fffdfc; border-style:solid">
          <div class="row" style="justify-content:space-between; gap:8px; flex-wrap:wrap">
            <div><span class="muted">Titolo:</span> <b id="resTitle">‚Äî</b></div>
            <div><span class="muted">Tag:</span> <b id="resTag">‚Äî</b></div>
          </div>
          <div style="height:10px"></div>
          <ul class="pretty-list" id="resList">
            <li class="muted" style="font-weight:600">Nessun dato da mostrare.</li>
          </ul>
        </div>

        <p class="muted" style="margin-top:10px">
          Dati salvati localmente (<span class="mono">localStorage</span>) e cifrati (AES-GCM con PBKDF2).
        </p>
      </section>
    </div>
  </div>

<script>
/* =========================
   Utilit√† tempo (Europe/Rome)
   ========================= */
function romeParts(date=new Date()){
  const p = new Intl.DateTimeFormat('en-GB',{
    timeZone:'Europe/Rome',
    weekday:'short', year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
  }).formatToParts(date);
  const get=t=>p.find(x=>x.type===t)?.value;
  return {
    weekday:get('weekday'), year:+get('year'), month:+get('month'), day:+get('day'),
    hour:+get('hour'), minute:+get('minute'), second:+get('second')
  };
}
function nextSundayAt21(){
  const now = new Date();
  const pr = romeParts(now);
  // Costruisci "oggi 00:00 Rome" in UTC-safe
  const baseUTC = Date.UTC(pr.year, pr.month-1, pr.day, 0,0,0);
  const todayRome = new Date(baseUTC);
  const wd = new Intl.DateTimeFormat('en-GB',{timeZone:'Europe/Rome', weekday:'short'}).format(todayRome);
  const idx = {Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6}[wd];
  let add = (7 - idx) % 7; // giorni fino a domenica
  // Se oggi √® domenica ma sono gi√† oltre le 21:00 Rome, vai a domenica prossima
  if (add===0){
    if (pr.hour > 21 || (pr.hour===21 && (pr.minute>0 || pr.second>0))) add = 7;
  }
  // Target "domenica ore 21:00 Rome" -> convertiamo in UTC basandoci su parti Rome
  // Stimiamo offset ‚Äúgrezzo‚Äù come pr.hour - now.getUTCHours(), ma preferiamo usare parti:
  // Facciamo: partire da baseUTC (oggi 00:00 Rome) + add giorni + (21:00 - 1h) compensazione euristica
  // (Mostrer√† countdown corretto in base alla stessa euristica anche sotto DST.)
  const targetUTC = Date.UTC(pr.year, pr.month-1, pr.day + add, 20, 0, 0); // 21:00 Rome ~ 20:00 UTC (approx)
  return new Date(targetUTC);
}
function msUntil(date){
  const pr = romeParts(new Date());
  const approxNowUTC = Date.UTC(pr.year, pr.month-1, pr.day, pr.hour-1, pr.minute, pr.second);
  return date.getTime() - approxNowUTC;
}
function fmtCountdown(ms){
  if (ms<0) ms=0;
  const s = Math.floor(ms/1000);
  const d = Math.floor(s/86400);
  const h = Math.floor((s%86400)/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  const pad = n => String(n).padStart(2,'0');
  return `${pad(d)}:${pad(h)}:${pad(m)}:${pad(sec)}`;
}

/* =========================
   Storage
   ========================= */
const KEY_DATA='schedina.pkg';     // cifrato
const KEY_META='schedina.meta';    // NON sensibile: { lockedUntilISO }
function saveMeta(meta){ localStorage.setItem(KEY_META, JSON.stringify(meta)); }
function loadMeta(){ try{ return JSON.parse(localStorage.getItem(KEY_META) || 'null'); }catch{return null}}
function clearAll(){ localStorage.removeItem(KEY_DATA); localStorage.removeItem(KEY_META); }
function hasSaved(){ return !!localStorage.getItem(KEY_DATA); }

/* =========================
   Crypto: PBKDF2 + AES-GCM
   ========================= */
function b64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function fromB64(b){ return Uint8Array.from(atob(b), c=>c.charCodeAt(0)); }
async function deriveKey(pass, salt){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:120000, hash:'SHA-256'},
    keyMaterial, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
  );
}
async function encryptJSON(obj, pass){
  const enc = new TextEncoder();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const key = await deriveKey(pass, salt);
  const data = enc.encode(JSON.stringify(obj));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
  return {v:1, iv:b64(iv), salt:b64(salt), ct:b64(ct)};
}
async function decryptJSON(pkg, pass){
  const iv = fromB64(pkg.iv), salt = fromB64(pkg.salt), ct = fromB64(pkg.ct);
  const key = await deriveKey(pass, salt);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
  return JSON.parse(new TextDecoder().decode(pt));
}

/* =========================
   UI refs
   ========================= */
const statePill = document.getElementById('statePill');

const editorCard = document.getElementById('editorCard');
const editorLock = document.getElementById('editorLock');
const lockUntilText = document.getElementById('lockUntilText');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const saveMsg = document.getElementById('saveMsg');
const titleEl = document.getElementById('title');
const contentEl = document.getElementById('content');
const passEl = document.getElementById('pass');
const tagEl = document.getElementById('tag');

const unlockState = document.getElementById('unlockState');
const countdownEl = document.getElementById('countdown');
const viewPassEl = document.getElementById('viewPass');
const viewBtn = document.getElementById('viewBtn');
const resetWeekBtn = document.getElementById('resetWeekBtn');
const viewMsg = document.getElementById('viewMsg');
const resTitle = document.getElementById('resTitle');
const resTag = document.getElementById('resTag');
const resList = document.getElementById('resList');

/* =========================
   Stato dinamico
   ========================= */
let target = nextSundayAt21(); // default
function setLockedUI(lockedUntil){
  // Editor bloccato
  [titleEl, contentEl, passEl, tagEl, saveBtn].forEach(el => el.disabled = true);
  editorLock.style.display = 'block';
  lockUntilText.textContent = new Intl.DateTimeFormat('it-IT', {
    timeZone:'Europe/Rome', weekday:'long', hour:'2-digit', minute:'2-digit'
  }).format(new Date(lockedUntil));
  statePill.innerHTML = 'üü£ Stato: <b>Bloccato</b>';
}
function setUnlockedUI(){
  [titleEl, contentEl, passEl, tagEl, saveBtn].forEach(el => el.disabled = false);
  editorLock.style.display = 'none';
  statePill.innerHTML = 'üü¢ Stato: <b>Sbloccato</b>';
}

function refreshState(){
  const meta = loadMeta();
  if (!meta){
    // Nessuna schedina: editor sbloccato, viewer ‚Äúin attesa‚Äù
    setUnlockedUI();
    unlockState.innerHTML = 'üü° In attesa di salvataggio (libero)';
    countdownEl.textContent = '00:00:00:00';
    return;
  }
  // C'√® una schedina: bloccato fino a Domenica
  target = new Date(meta.lockedUntilISO);
  setLockedUI(meta.lockedUntilISO);
}

function tick(){
  const meta = loadMeta();
  if (!meta){
    requestAnimationFrame(()=>setTimeout(tick, 600));
    return;
  }
  const remain = msUntil(new Date(meta.lockedUntilISO));
  countdownEl.textContent = fmtCountdown(remain);
  if (remain<=0){
    unlockState.innerHTML = '<span class="success">‚úÖ Sbloccato: puoi visualizzare</span>';
  }else{
    unlockState.innerHTML = 'üîí Ancora bloccato fino a Domenica 21:00';
  }
  requestAnimationFrame(()=>setTimeout(tick, 500));
}

/* =========================
   Handlers
   ========================= */
async function handleSave(){
  saveMsg.textContent = '';
  const title = (titleEl.value||'').trim();
  const content = (contentEl.value||'').trim();
  const pass = (passEl.value||'').trim();
  const tag = (tagEl.value||'').trim();

  if (!title || !content || !pass){
    saveMsg.innerHTML = '<span class="error">Compila titolo, contenuto e passphrase.</span>';
    return;
  }
  try{
    // Cifra e salva
    const pkg = await encryptJSON({title, content, tag, savedAt:new Date().toISOString()}, pass);
    localStorage.setItem(KEY_DATA, JSON.stringify(pkg));

    // Blocca fino a Domenica 21:00 calcolando nel momento del salvataggio
    const lockedUntil = nextSundayAt21();
    saveMeta({lockedUntilISO: lockedUntil.toISOString()});

    // UI
    setLockedUI(lockedUntil.toISOString());
    saveMsg.innerHTML = '<span class="success">üéâ Salvato! Ora √® bloccato fino a Domenica 21:00.</span>';

    // mini-confettini (emoji)
    burst();
  }catch(e){
    console.error(e);
    saveMsg.innerHTML = '<span class="error">Errore nel salvataggio.</span>';
  }
}

function handleClear(){
  clearAll();
  setUnlockedUI();
  saveMsg.innerHTML = '<span class="success">Pulito tutto. Editor sbloccato.</span>';
  // Pulisci viewer
  resTitle.textContent='‚Äî'; resTag.textContent='‚Äî';
  resList.innerHTML='<li class="muted" style="font-weight:600">Nessun dato da mostrare.</li>';
  unlockState.innerHTML='üü° In attesa di salvataggio (libero)';
  countdownEl.textContent='00:00:00:00';
}

function handleResetWeek(){
  // Consenti reset solo se ormai √® sbloccato
  const meta = loadMeta();
  if (!meta){
    viewMsg.innerHTML = '<span class="error">Non c‚Äô√® nulla da resettare.</span>';
    return;
  }
  const remain = msUntil(new Date(meta.lockedUntilISO));
  if (remain>0){
    viewMsg.innerHTML = '<span class="error">Puoi avviare una nuova settimana solo dopo Domenica 21:00.</span>';
    return;
  }
  handleClear();
  viewMsg.innerHTML = '<span class="success">Settimana azzerata. Puoi inserire una nuova schedina!</span>';
}

async function handleView(){
  viewMsg.textContent = '';
  const meta = loadMeta();
  if (!meta){ viewMsg.innerHTML = '<span class="error">Nessuna schedina salvata.</span>'; return; }

  const remain = msUntil(new Date(meta.lockedUntilISO));
  if (remain>0){
    viewMsg.innerHTML = '<span class="error">Disponibile solo dopo Domenica 21:00.</span>';
    return;
  }
  const pkgStr = localStorage.getItem(KEY_DATA);
  if (!pkgStr){ viewMsg.innerHTML = '<span class="error">Dati mancanti.</span>'; return; }

  const pass = (viewPassEl.value||'').trim();
  if (!pass){ viewMsg.innerHTML = '<span class="error">Inserisci la passphrase.</span>'; return; }

  try{
    const pkg = JSON.parse(pkgStr);
    const data = await decryptJSON(pkg, pass);

    // Output carino
    resTitle.textContent = data.title || '‚Äî';
    resTag.textContent = data.tag || '‚Äî';
    const lines = (data.content||'').split('\n').map(s=>s.trim()).filter(Boolean);

    if (lines.length===0){
      resList.innerHTML = '<li class="muted" style="font-weight:600">Contenuto vuoto.</li>';
    } else {
      resList.innerHTML = '';
      for (const ln of lines){
        const li = document.createElement('li');
        const dot = document.createElement('span');
        dot.className = 'pretty-dot';
        const text = document.createElement('span');

        // Decorazioni 1X2/Over
        let html = ln
          .replace(/\b(1|X|2)\b/g, '<span class="hl">$1</span>')
          .replace(/\b(Over\s*\d+(?:\.\d+)?)\b/ig, '<span class="hl2">$1</span>')
          .replace(/\b(Under\s*\d+(?:\.\d+)?)\b/ig, '<span class="hl2">$1</span>');
        text.innerHTML = html;

        li.appendChild(dot);
        li.appendChild(text);
        resList.appendChild(li);
      }
    }
    viewMsg.innerHTML = '<span class="success">Schedina mostrata ‚úî</span>';
  }catch(e){
    console.error(e);
    viewMsg.innerHTML = '<span class="error">Passphrase errata o dati corrotti.</span>';
  }
}

/* =========================
   Piccola animazione ‚Äúconfetti‚Äù
   ========================= */
function burst(){
  const emojis = ['‚ú®','üéâ','üí•','üéä','üåü'];
  const n = 14;
  for (let i=0;i<n;i++){
    const s = document.createElement('div');
    s.textContent = emojis[Math.floor(Math.random()*emojis.length)];
    s.style.position='fixed';
    s.style.left = (window.innerWidth/2 + (Math.random()-0.5)*240) + 'px';
    s.style.top = (window.innerHeight/2 + (Math.random()-0.5)*80) + 'px';
    s.style.fontSize = (18 + Math.random()*10) + 'px';
    s.style.transform = `rotate(${(Math.random()*40-20)}deg)`;
    s.style.opacity='1';
    s.style.transition='transform 700ms ease-out, opacity 700ms ease-out';
    document.body.appendChild(s);
    requestAnimationFrame(()=>{
      s.style.transform += ` translate(${(Math.random()-0.5)*160}px, ${60+Math.random()*120}px)`;
      s.style.opacity='0';
    });
    setTimeout(()=>s.remove(), 800);
  }
}

/* =========================
   Init
   ========================= */
function init(){
  refreshState();
  tick();
  saveBtn.addEventListener('click', handleSave);
  clearBtn.addEventListener('click', handleClear);
  viewBtn.addEventListener('click', handleView);
  resetWeekBtn.addEventListener('click', handleResetWeek);

  // Placeholder UI: se esiste pacchetto, cambia titolo pagina
  if (hasSaved()){ document.title = 'Schedina ‚Äì bloccata fino a Domenica'; }
}
init();
</script>
</body>
</html>
