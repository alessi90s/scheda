<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Schedina ‚Äì Blocco fino a Domenica sera</title>
<style>
  :root{
    --bg:#0f1115; --card:#151922; --ink:#e9eefb; --muted:#a9b3c7; --accent:#86a9ff;
    --ok:#89f7a1; --warn:#ffd479; --bad:#ff9c9c; --hl1:#fff1a8; --hl2:#ffd9ec; --hl3:#c7fff1;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(180deg,#0d0f14,#10131a 30%,#0f1115);
    color:var(--ink); font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .wrap{width:100%; max-width:980px; display:grid; gap:18px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between}
  h1{margin:0; font-size:22px; letter-spacing:0.2px}
  .pill{font-size:12px; color:#0b1020; background:var(--accent); padding:6px 10px; border-radius:999px; font-weight:600}
  .grid{display:grid; gap:18px}
  @media(min-width:900px){ .grid{grid-template-columns:1.1fr .9fr} }

  .card{background:var(--card); border:1px solid #202638; border-radius:16px; padding:18px 16px; box-shadow:0 10px 30px rgb(0 0 0 / 25%)}
  .card h2{margin:0 0 8px 0; font-size:18px}
  .muted{color:var(--muted); font-size:13px}

  label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
  input[type="text"], input[type="password"], textarea{
    width:100%; background:#0c0f16; color:var(--ink); border:1px solid #272d3e; border-radius:10px;
    padding:10px 12px; outline:none; box-shadow:inset 0 0 0 9999px rgba(255,255,255,0);
  }
  textarea{min-height:140px; resize:vertical}
  .row{display:flex; gap:10px; align-items:center}
  .btn{
    border:1px solid #2a3350; background:#172139; color:var(--ink); padding:10px 14px; border-radius:12px; cursor:pointer;
    font-weight:600; transition:transform .04s ease, background .2s, border-color .2s;
  }
  .btn:hover{background:#1c2946}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent); color:#0c1020; border-color:#648bff}
  .btn.good{background:#0f2717; border-color:#1d5b32; color:#a1f5b3}
  .btn.warn{background:#2e240a; border-color:#6b5312; color:#ffe098}
  .tag{display:inline-block; padding:2px 8px; border-radius:999px; border:1px dashed #2f3751; color:var(--muted); font-size:12px}

  .hl{background:var(--hl1); color:#181b22; padding:2px 6px; border-radius:6px}
  .hl2{background:var(--hl2); color:#2a0b18; padding:2px 6px; border-radius:6px}
  .hl3{background:var(--hl3); color:#06231d; padding:2px 6px; border-radius:6px}

  .callout{border-left:4px solid var(--accent); padding:10px 12px; background:#0c101b; border-radius:8px}
  .sep{height:1px; background:#20263a; margin:12px 0}

  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .center{display:flex; align-items:center; justify-content:center}
  .big{font-size:28px; font-weight:800; letter-spacing:.5px}
  .count{font-variant-numeric:tabular-nums; font-weight:700}

  .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
  .chip{padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #2a3150}
  .chip.fixed{background:var(--hl1)}
  .chip.over{background:var(--hl2)}
  .chip.alt{background:var(--hl3)}
  .hidden{display:none !important}
  .success{color:var(--ok)}
  .error{color:var(--bad)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Schedina <span class="muted">| visibile solo <span class="hl">Domenica ore 21:00</span> (Europe/Rome)</span></h1>
      <span id="statePill" class="pill">Verifica orario‚Ä¶</span>
    </header>

    <div class="grid">
      <!-- EDITOR -->
      <section class="card" id="editorCard">
        <h2>Inserisci la schedina <span class="tag">consentito: Marted√¨ / Mercoled√¨</span></h2>
        <p class="muted">Compila i campi e premi <b>Salva cifrato</b>. I dati vengono cifrati localmente (AES-GCM) e salvati nel tuo browser.</p>

        <div class="chips">
          <span class="chip fixed">1X2 (fissi)</span>
          <span class="chip over">Over/Under</span>
          <span class="chip alt">Altri mercati</span>
        </div>

        <label for="title">Titolo/Etichetta</label>
        <input id="title" type="text" placeholder="Schedina turno 34 ‚Äì Serie A & Liga">

        <label for="content">Contenuto (uno per riga, es: ‚ÄúMilan‚ÄìLecce 1‚Äù, ‚ÄúBilbao‚ÄìGirona Over 2.5‚Äù)</label>
        <textarea id="content" placeholder="Napoli ‚Äì Pisa 1&#10;Frosinone ‚Äì Cagliari X&#10;Udinese ‚Äì Palermo 1&#10;Milan ‚Äì Lecce 1&#10;Ath. Bilbao ‚Äì Girona Over 2.5"></textarea>

        <div class="row">
          <div style="flex:1">
            <label for="pass">Passphrase (per cifrare/decifrare)</label>
            <input id="pass" type="password" placeholder="La tua chiave segreta">
          </div>
          <div style="width:170px">
            <label for="tag">Tag</label>
            <input id="tag" type="text" placeholder="Settimana 38">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="saveBtn">üíæ Salva cifrato</button>
          <button class="btn warn" id="clearBtn" title="Rimuove la schedina salvata">üóëÔ∏è Pulisci salvataggio</button>
          <span id="saveMsg" class="muted"></span>
        </div>

        <div id="editorLock" class="callout" style="margin-top:12px">
          <b>Editor bloccato.</b> L‚Äôediting √® disponibile solo <span class="hl">Marted√¨</span> e <span class="hl">Mercoled√¨</span> (zona oraria Europe/Rome).
        </div>
      </section>

      <!-- VIEWER -->
      <section class="card" id="viewerCard">
        <h2>Visualizza schedina <span class="tag">sblocco: Domenica 21:00</span></h2>
        <div class="callout">
          <div><b>Stato sblocco:</b> <span id="unlockState" class="mono">verifica‚Ä¶</span></div>
          <div class="sep"></div>
          <div class="row" style="gap:12px">
            <div class="big count" id="countdown">00:00:00:00</div>
            <div class="muted">gg : hh : mm : ss</div>
          </div>
        </div>

        <label for="viewPass">Passphrase (necessaria dopo lo sblocco)</label>
        <input id="viewPass" type="password" placeholder="La stessa usata in fase di salvataggio">

        <div class="row" style="margin-top:12px">
          <button class="btn good" id="viewBtn">üîì Mostra</button>
          <span id="viewMsg" class="muted"></span>
        </div>

        <div id="result" class="card" style="margin-top:14px; background:#0d121e; border-style:dashed">
          <div id="resHead" class="row" style="justify-content:space-between">
            <div><span class="muted">Titolo:</span> <b id="resTitle">‚Äî</b></div>
            <div><span class="muted">Tag:</span> <b id="resTag">‚Äî</b></div>
          </div>
          <div class="sep"></div>
          <div id="resBody" style="white-space:pre-wrap; font-size:15px">Nessun dato.</div>
        </div>

        <p class="muted" style="margin-top:10px">
          I dati sono conservati solo nel tuo browser (<span class="mono">localStorage</span>) con cifratura AES-GCM.
        </p>
      </section>
    </div>
  </div>

<script>
/* ========= Utilit√† tempo: Europe/Rome ========= */
function romeNow(){
  // Ottiene una Date ‚Äúequivalente‚Äù all‚Äôorario Europe/Rome
  const s = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'Europe/Rome',
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
  }).format(new Date()); // "YYYY-MM-DD, HH:MM:SS"
  const [date, time] = s.split(', ');
  return new Date(date + 'T' + time + '+01:00'); // offset non perfetto in DST, ma la parte romeNowParts compensa
}
function romeNowParts(){
  const p = new Intl.DateTimeFormat('en-GB',{
    timeZone:'Europe/Rome',
    weekday:'short', year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
  }).formatToParts(new Date());
  const get = t => p.find(x=>x.type===t)?.value;
  return {
    weekday: get('weekday'), // Mon, Tue...
    year: +get('year'), month: +get('month'), day: +get('day'),
    hour: +get('hour'), minute:+get('minute'), second:+get('second')
  };
}
function isTueOrWed(){
  const d = new Intl.DateTimeFormat('en-GB',{timeZone:'Europe/Rome', weekday:'short'}).format(new Date());
  return d === 'Tue' || d === 'Wed';
}
function nextSundayAt(hour=21, minute=0){
  // Ritorna Date dell‚Äôimmediata Domenica alle 21:00 Europe/Rome
  const now = new Date();
  const parts = romeNowParts();
  // Costruisco una data locale Rome ‚Äúoggi alle 00:00‚Äù
  const todayRome = new Date(Date.UTC(parts.year, parts.month-1, parts.day, 0,0,0));
  // weekday index: Sun=0, Mon=1, ...; creato dal todayRome come UTC
  let wd = new Intl.DateTimeFormat('en-GB',{timeZone:'Europe/Rome', weekday:'short'}).format(todayRome);
  const map = {Sun:0, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6};
  let n = map[wd];
  let add = (7 - n) % 7; // giorni da oggi a domenica
  if (add===0){
    // se oggi √® gi√† domenica, decidi se √® ‚Äúoggi alle 21‚Äù o la prossima
    if (parts.hour < hour || (parts.hour===hour && parts.minute<minute)) add = 0; else add = 7;
  }
  const target = new Date(Date.UTC(parts.year, parts.month-1, parts.day + add, hour-1, minute, 0)); 
  // -1 ora grezza per compensare l'offset approssimato; visuale countdown resta coerente con parts (Europe/Rome)
  return target;
}
function msUntil(date){
  const nowParts = romeNowParts();
  const nowUTCapprox = new Date(Date.UTC(nowParts.year, nowParts.month-1, nowParts.day, nowParts.hour-1, nowParts.minute, nowParts.second));
  return date - nowUTCapprox;
}

/* ========= Crypto: PBKDF2 + AES-GCM ========= */
async function deriveKey(pass, salt){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw', enc.encode(pass), {name:'PBKDF2'}, false, ['deriveKey']
  );
  return crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations: 120000, hash:'SHA-256'},
    keyMaterial, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
  );
}
function b64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function fromB64(b){ return Uint8Array.from(atob(b), c=>c.charCodeAt(0)); }

async function encryptJSON(obj, pass){
  const enc = new TextEncoder();
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const key = await deriveKey(pass, salt);
  const data = enc.encode(JSON.stringify(obj));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
  return {
    v:1, salt:b64(salt), iv:b64(iv), ct:b64(ct)
  };
}
async function decryptJSON(pkg, pass){
  const iv = fromB64(pkg.iv), salt = fromB64(pkg.salt), ct = fromB64(pkg.ct);
  const key = await deriveKey(pass, salt);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
  const dec = new TextDecoder().decode(pt);
  return JSON.parse(dec);
}

/* ========= Storage ========= */
const KEY='schedina.pkg';

function savePkg(pkg){
  localStorage.setItem(KEY, JSON.stringify(pkg));
}
function loadPkg(){
  const s = localStorage.getItem(KEY);
  if(!s) return null;
  try { return JSON.parse(s); } catch{ return null; }
}
function clearPkg(){
  localStorage.removeItem(KEY);
}

/* ========= UI Logic ========= */
const statePill = document.getElementById('statePill');
const editorCard = document.getElementById('editorCard');
const editorLock = document.getElementById('editorLock');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const saveMsg = document.getElementById('saveMsg');
const titleEl = document.getElementById('title');
const contentEl = document.getElementById('content');
const passEl = document.getElementById('pass');
const tagEl = document.getElementById('tag');

const unlockState = document.getElementById('unlockState');
const countdownEl = document.getElementById('countdown');
const viewPassEl = document.getElementById('viewPass');
const viewBtn = document.getElementById('viewBtn');
const viewMsg = document.getElementById('viewMsg');
const resTitle = document.getElementById('resTitle');
const resTag = document.getElementById('resTag');
const resBody = document.getElementById('resBody');

function updateEditorAvailability(){
  const ok = isTueOrWed();
  editorLock.classList.toggle('hidden', ok);
  // Disabilito input se non ok
  [titleEl, contentEl, passEl, tagEl, saveBtn].forEach(el=> el.disabled = !ok);
  statePill.textContent = ok ? 'Editing attivo (Mar/Mer)' : 'Editing bloccato';
  statePill.style.background = ok ? 'var(--accent)' : '#2a3147';
  statePill.style.color = ok ? '#0b1020' : '#9fb0d0';
}

function fmtCountdown(ms){
  if (ms < 0) ms = 0;
  const s = Math.floor(ms/1000);
  const d = Math.floor(s/86400);
  const h = Math.floor((s%86400)/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  const pad = n => String(n).padStart(2,'0');
  return `${pad(d)}:${pad(h)}:${pad(m)}:${pad(sec)}`;
}
let target = nextSundayAt(21,0);
function tick(){
  // Unlock?
  const remain = msUntil(target);
  countdownEl.textContent = fmtCountdown(remain);
  if (remain<=0){
    unlockState.innerHTML = '<span class="success">‚úÖ Sbloccato: Domenica ‚â• 21:00</span>';
  } else {
    unlockState.innerHTML = 'üîí Ancora bloccato';
  }
  requestAnimationFrame(()=> setTimeout(tick, 500));
}

async function handleSave(){
  saveMsg.textContent = '';
  const title = (titleEl.value||'').trim();
  const content = (contentEl.value||'').trim();
  const pass = (passEl.value||'').trim();
  const tag = (tagEl.value||'').trim();
  if (!title || !content || !pass){
    saveMsg.innerHTML = '<span class="error">Compila titolo, contenuto e passphrase.</span>';
    return;
  }
  try{
    const pkg = await encryptJSON({
      title, content, tag, savedAt: new Date().toISOString()
    }, pass);
    savePkg(pkg);
    saveMsg.innerHTML = '<span class="success">Salvato e cifrato ‚úî</span>';
    contentEl.value = '';
    // (opzionale) mantieni titolo/tag
  }catch(e){
    console.error(e);
    saveMsg.innerHTML = '<span class="error">Errore nel salvataggio.</span>';
  }
}
function handleClear(){
  clearPkg();
  saveMsg.innerHTML = '<span class="success">Salvataggio rimosso.</span>';
  resTitle.textContent = '‚Äî'; resTag.textContent = '‚Äî'; resBody.textContent='Nessun dato.';
}

async function handleView(){
  viewMsg.textContent = '';
  const remain = msUntil(target);
  if (remain>0){
    viewMsg.innerHTML = '<span class="error">Disponibile solo dopo Domenica 21:00.</span>';
    return;
  }
  const pkg = loadPkg();
  if (!pkg){
    viewMsg.innerHTML = '<span class="error">Nessuna schedina salvata.</span>';
    return;
  }
  const pass = (viewPassEl.value||'').trim();
  if (!pass){
    viewMsg.innerHTML = '<span class="error">Inserisci la passphrase.</span>';
    return;
  }
  try{
    const data = await decryptJSON(pkg, pass);
    resTitle.textContent = data.title || '‚Äî';
    resTag.textContent = data.tag || '‚Äî';
    // Abbellimento con evidenziatori pastello per certe parole chiave
    const decorated = (data.content||'')
      .split('\n')
      .map(line=>{
        let l = line
          .replace(/\b(1|X|2)\b/g, '<span class="hl">'+ '$1' +'</span>')
          .replace(/\b(Over\s*[\d\.]+|Under\s*[\d\.]+)\b/gi, '<span class="hl2">$1</span>');
        return '‚Ä¢ ' + l;
      }).join('\n');
    resBody.innerHTML = decorated;
    viewMsg.innerHTML = '<span class="success">Schedina mostrata.</span>';
  }catch(e){
    console.error(e);
    viewMsg.innerHTML = '<span class="error">Passphrase errata o dati corrotti.</span>';
  }
}

/* ========= Init ========= */
updateEditorAvailability();
tick();
saveBtn.addEventListener('click', handleSave);
clearBtn.addEventListener('click', handleClear);
viewBtn.addEventListener('click', handleView);

// Aggiorna blocco editor ogni minuto (cambio giorno)
setInterval(updateEditorAvailability, 60_000);

// Se esiste un pacchetto salvato, mostra tag/titolo placeholder dalla metadati (senza decifrare)
(function previewMeta(){
  const pkg = loadPkg();
  if (!pkg) return;
  // Non si decifra: manteniamo privacy. Mostriamo solo ‚Äúsalvato presente‚Äù.
  document.title = 'Schedina ‚Äì salvata (in attesa di sblocco)';
})();
</script>
</body>
</html>
